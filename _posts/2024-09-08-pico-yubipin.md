---
title: "Проект выходного дня: PicoYubiPin"
classes: wide
header:
  og_image: /assets/images/posts/pico-yubipin/cover.png
categories:
  - security
redirect_from:
  - /iot/esphome/pico-yubipin/
---

Уж не знаю как так вышло, но в последнее время мне то и дело хочется подебагать USB. И пока я для себя не решил, каким должен быть идеальный USB Sniffer (напишу как узнаю ^^), решил запилить небольшую демку подглядывания в USB трафике PIN от PIV в [Yubikey](https://www.yubico.com/authentication-standards/smart-card/).

![cover](/assets/images/posts/pico-yubipin/cover.png){: .align-center}

Это постик о проекте выходного дня, погнали :)
## Ю-би-кей?
Но сперва немного про сам Yubikey. Не бойтесь, я не псих, писать полноценный обзор не вижу смысла - их и так хватает в интернетах ([например](https://blog.ctis.me/2022/12/yubikey-piv-gpg/)). Скажу лишь, что в общем случае Yubikey (любой 5x серии) - крутая маленькая штучка. Быстрый микрочип, поддержка кучи апплетов (FIDO2, PIV, OpenPGP, etc), аттестация, вариации user presence, не экспортируемость ключей (по модулю наличия уязвимостей ^^) и т.д.

Этот постик про PIV (Personal Identity Verification) card, поэтому далее говорим только о нем. В двух словах, PIV апплет Yubikey позволяет хранить RSA/ECDSA/Ed25519 ключевые пары, X.509* сертификат к ним и производить базовые криптографические операции. А коль это покрывает большую часть аутентификаций по ключу - мне то и дело пытаются продать идею хранения всего и вся в нем. Идея эта, скажем так, не всегда находит отклик во мне, т.к. сильно зависит от конкретного применения.

Для примера давайте представим себе сетап какого-нить работяги из разработки:
  - PIV хранит RSA/ECDSA ключ + X.509 сертификат для доступа в сеть
  - PIV хранит RSA/ECDSA/Ed25519 ключ для доступа по SSH и/или Github
  - OPGP хранит OpenPGP ключи для подписи пакетов, писем, etc
  - FIDO2 используется для многофакторной аутентификации

Если говорить о безопасносте PIV, то мы имеем:
  - экспортировать/скопировать ключи злоумышленник не может
  - любая малварь должна будет закрепиться, мутить какой-нить канал для подписи и (возможно) даже ждать подходящий момент для подписи
  - при физическом же доступе злоумышленник должен знать PIN от PIV

Погоди-ка PIN? Ну да, смарт-карта должна авторизовать запрос перед подписью, делается это с помощью PIN (6-8 символов). По умолчанию Yubikey имеет лимит в 3 попытки ввода PIN + 3 попытки ввода PUK (позволяет сбросить PIN). Звучит логично.
## Так, ну и что не так?
Да все так, покуда мы считаем физический доступ out of scope. Но вынести физический доступ за скоуп в своей модели угроз это одно, а что будет в случае реального инцидента - совсем другое. Ведь скорее всего наш работяга (я, например):
  - всегда держит свой yubikey в ноуте, а значит он и теряет/оставляет их вместе
  - хранит PIN на fs и автоматически поднимает себе VPN, иначе, опять-таки, жизни нет
  - но шифрует fs, иначе у нас куда большие проблемки ;)

Это означает, что исключать физический доступ мы не можем, а любой физический доступ даст злоумышленнику и ключи для аутентификации/авторизации, и пароль для доступа к ним.

## Эмммм...но ведь...
Но ведь коммуникация между Yubikey и софтом как-то шифруется? Поди на каком-нить сессионном ключе, так ведь? Ну...если найдете способ это провернуть - напишите на [dev@buglloc.cc](mailto:dev@buglloc.cc) плиз, с меня пивас ;)

А пока имеем, что имеем - любая авторизация с человеком посредине - gg. Например, это смена PIN (см. [APDU: Change reference data](https://docs.yubico.com/yesdk/users-manual/application-piv/apdu/change-ref.html)) с `123456` на `654321`:
![cover](/assets/images/posts/pico-yubipin/piv_change_pin.png){: .align-center}

Получается, все по классике MitM:
  - злоумышленник начинает пассивно (!) слушать USB трафик
  - открывает крышку ноута
  - тот просыпается, идет поднимать VPN
  - тот авторизуется в PIV
  * вот злоумышленник и получает все, чего желал

На мой вкус, это столь же удивительный факт, сколь и известный. История знает разнообразные исследования, сам я проворачивал такое в 2022 с помощью эмулятора смарт-карт и малинки. В общем, я вас предупредил ;)
## О PicoYubiPin
Но это все слова, давайте уже к делу! Как я и говорил в самом начале, какое-то время назад я начал мечтать о идеальном USB сниффере. А пока его не нашлось, решил написать простенький сниффер для получения PIN от PIV. Так субботним вечером и родился [PicoYubiPin](https://github.com/buglloc/pico_yubipin/). Написан он на С и по своей сути является USB сниффером (cпасибо [pico_usb_sniffer](https://github.com/tana/pico_usb_sniffer) за вдохновение) с фильтром, [который должен пропустить всего один пакетик](https://github.com/buglloc/pico_yubipin/blob/69a26f273d0adc414d6ad3bf54c05ee2ffd2ebed/main.cc#L192-L236) (уровни снизу вверх):
  - USB Link Layer: `PID == 0x3 || PID == 0xB` (`DATA0` или `DATA1`)
  - CCID: `MessageType == XfrBlock`
  - PC/SC: `APDU VerifyPin` (см. [APDU: Verify PIN](https://docs.yubico.com/yesdk/users-manual/application-piv/apdu/verify.html))

Ну и вывести результат на дисплей. Ничего хитрого, поэтому давайте о хардваре!
## PicoYubiPin: хардваре
Название намекает, потому основу я взял [RP2040 Zero](https://www.waveshare.com/wiki/RP2040-Zero):
  - дешевый ($1-2 на распродаже)
  - популярный
  - с быстрым доступом к портам

И IIC дисплейчик [0.96'' OLED от WeAct](https://github.com/WeActStudio/WeActStudio.OLEDModule) (долго не выбирал, был в наличии). По итогу получилась такая схема:
![cover](/assets/images/posts/pico-yubipin/schema.excalidraw.svg){: .align-center}

Осталось взять пару usb гнезд, горстку проводков и все подсобрать:
![cover](/assets/images/posts/pico-yubipin/built.jpg){: .align-center}

## PicoYubiPin: демо
Вот и все, самое время подключить Yubikey и попросить [yubico-piv-tool](https://developers.yubico.com/yubico-piv-tool/) проверить подпись на ключе из слота `0x9a`:
  - готовимся:
![cover](/assets/images/posts/pico-yubipin/prepare.jpg){: .align-center}
  - запускаем `yubico-piv-tool` :
![cover](/assets/images/posts/pico-yubipin/boom.jpg){: .align-center}
  - Та-дам, вот и PIN, который мы использовали при авторизации

## Closure
Каких-то особых выводов у меня сегодня нет. Просто будьте бдительны, прошу :)

А пока у меня все, всем кота (づ˶•༝•˶)づ♡
